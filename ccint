#!/bin/sh

start_path="$(pwd)"
script="$1"
if ! [ -f "${script}" ]; then
    echo "\"${script}\" - file not found" >&2
    exit 1
fi
shift
base="$(basename "${script}" .cc)"

# prefer memory
if [ -d "/dev/shm" ]; then
    temp="$(mktemp -p /dev/shm -d)"
elif [ -d "/run/shm" ]; then
    temp="$(mktemp -p /run/shm -d)"
else
    temp="$(mktemp -d)"
fi

if [ ! -d "${temp}" ]; then
    echo "failed to create \"${temp}\""
    exit 1
fi

if [ -z "${CXX}" ]; then
    if command -v "g++" >/dev/null 2>&1; then
        CXX="g++"
    elif command -v "clang++" >/dev/null 2>&1; then
        CXX="clang++"
    fi
fi

if [ -z "${CXXFLAGS}" ]; then
    CXXFLAGS="-pipe -pedantic -Wall -Wextra -O3"
fi

if [ -z "${LDFLAGS}" ]; then
    # try link common libs
    LDFLAGS="-lm -lrt -lpthread -ldl"
fi

echo "+ ${CXX} ${CXXFLAGS} -o \"${temp}/${base}\" \"${script}\" ${LDFLAGS}"
if ! ${CXX} ${CXXFLAGS} -o "${temp}/${base}" "${script}" ${LDFLAGS}; then
    rm -r "${temp}"
    exit 1
fi

(cd "${temp}" && "./${base}" "$@")

rm -r "${temp}"
