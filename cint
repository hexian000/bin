#!/bin/sh

script="$1"
if ! [ -f "${script}" ]; then
	echo "\"${script}\" - file not found" >&2
	exit 1
fi
shift
base="$(basename "${script}" .c)"

# prefer memory
if [ -d "/dev/shm" ]; then
	temp="$(mktemp -p /dev/shm -d)"
elif [ -d "/run/shm" ]; then
	temp="$(mktemp -p /run/shm -d)"
else
	temp="$(mktemp -d)"
fi

if [ ! -d "${temp}" ]; then
	echo "failed to create \"${temp}\""
	exit 1
fi

if [ -z "${CC}" ]; then
	if command -v "gcc" >/dev/null 2>&1; then
		CC="gcc"
	elif command -v "clang" >/dev/null 2>&1; then
		CC="clang"
	fi
fi

if [ -z "${CFLAGS}" ]; then
	CFLAGS="-pipe -pedantic -Wall -Wextra -Werror -O3"
fi

if [ -z "${LDFLAGS}" ]; then
	# try link common libs
	LDFLAGS="-lm -lrt -lpthread -ldl"
fi

echo "+ ${CC} ${CFLAGS} -o \"${temp}/${base}\" \"${script}\" ${LDFLAGS}"
if ! ${CC} ${CFLAGS} -o "${temp}/${base}" "${script}" ${LDFLAGS}; then
	rm -r "${temp}"
	exit 1
fi

(cd "${temp}" && "./${base}" "$@")

rm -r "${temp}"
